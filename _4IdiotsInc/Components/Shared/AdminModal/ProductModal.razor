@using _4IdiotsInc.Model
@rendermode InteractiveServer

@if (IsVisible)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">@(IsEditMode ? "Edit Product" : "Add New Product")</h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="Product" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />

                        @* Image Upload *@
                        <div class="mb-3 text-center">
                            <div class="position-relative d-inline-block">
                                @if (!string.IsNullOrEmpty(Product.ImageUrl))
                                {
                                    <img src="@Product.ImageUrl" alt="Product"
                                         class="rounded" style="width: 120px; height: 120px; object-fit: cover;">
                                }
                                else
                                {
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                         style="width: 120px; height: 120px;">
                                        <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                                    </div>
                                }
                                <label class="position-absolute bottom-0 end-0 btn btn-sm btn-primary rounded-circle"
                                       style="width: 32px; height: 32px; padding: 0;">
                                    <i class="bi bi-camera"></i>
                                    <InputFile OnChange="HandleImageUpload" accept="image/*" class="d-none" />
                                </label>
                            </div>
                            <div class="text-muted small mt-2">Click camera to upload image</div>
                        </div>

                        @* Product Name *@
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Product Name</label>
                            <InputText @bind-Value="Product.Name" class="form-control"
                                       placeholder="Enter product name" />
                            <ValidationMessage For="@(() => Product.Name)" />
                        </div>

                        @* Price and Stock Side by Side *@
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label fw-semibold">Price (₱)</label>
                                <InputNumber @bind-Value="Product.Price" class="form-control"
                                             placeholder="0.00" step="0.01" />
                                <ValidationMessage For="@(() => Product.Price)" />
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-semibold">Initial Stock</label>
                                <InputNumber @bind-Value="Product.Stock" class="form-control"
                                             placeholder="0" />
                                <ValidationMessage For="@(() => Product.Stock)" />
                            </div>
                        </div>

                        @* Category *@
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Category</label>
                            <InputSelect @bind-Value="Product.CategoryId" class="form-select">
                                <option value="0">Select category</option>
                                @foreach (var category in Categories)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => Product.CategoryId)" />
                        </div>

                        @* Description *@
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Description</label>
                            <InputTextArea @bind-Value="Product.Description" class="form-control"
                                           rows="3" placeholder="Enter product description" />
                            <ValidationMessage For="@(() => Product.Description)" />
                        </div>

                        @* Submit Button *@
                        <button type="submit" class="btn btn-primary w-100 py-2">
                            @(IsEditMode ? "Update Product" : "Add Product")
                        </button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<Products> OnSave { get; set; }
    [Parameter] public Products Product { get; set; } = new();
    [Parameter] public List<ProductCategory> Categories { get; set; } = new();
    [Parameter] public bool IsEditMode { get; set; }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null) return;

            // Limit file size to 5MB
            using var stream = file.OpenReadStream(maxAllowedSize: 5_000_000);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            var bytes = ms.ToArray();
            Product.ImageUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(bytes)}";

            // Force UI update
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading image: {ex.Message}");
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            await OnSave.InvokeAsync(Product);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in submit: {ex.Message}");
        }
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}
