@rendermode InteractiveServer
@inject _4IdiotsInc.Components.Service.CartService CartService
@inject _4IdiotsInc.Components.Service.CheckoutService CheckoutService
@inject NavigationManager Navigation
@implements IDisposable

<!-- Overlay -->
@if (isOpen)
{
    <div class="cart-overlay" @onclick="CloseCart"></div>
}

<!-- Sidebar -->
<div class="cart-sidebar @(isOpen ? "open" : "")">
    <!-- Header -->
    <div class="cart-header">
        <h5 class="mb-0">Shopping Cart (@CartService.ItemCount)</h5>
        <button class="btn-close" @onclick="CloseCart"></button>
    </div>

    <!-- Cart Items -->
    <div class="cart-body">
        @if (isProcessing)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <p class="mt-3">Processing your order...</p>
            </div>
        }
        else if (!CartService.CartItems.Any())
        {
            <div class="empty-cart">
                <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
                <p class="mt-3 text-muted">Your cart is empty</p>
            </div>
        }
        else
        {
            @foreach (var item in CartService.CartItems)
            {
                <div class="cart-item">
                    <img src="@item.ImageUrl" alt="@item.ProductName" class="cart-item-img">
                    <div class="cart-item-details">
                        <h6 class="mb-1">@item.ProductName</h6>
                        <p class="text-primary mb-2">₱@item.Price.ToString("N2")</p>
                        <div class="quantity-controls">
                            <button class="btn btn-sm btn-outline-secondary"
                                    @onclick="() => DecreaseQuantity(item.ProductId)"
                                    disabled="@isProcessing">
                                <i class="bi bi-dash"></i>
                            </button>
                            <span class="mx-2">@item.Quantity</span>
                            <button class="btn btn-sm btn-outline-secondary"
                                    @onclick="() => IncreaseQuantity(item.ProductId)"
                                    disabled="@isProcessing">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-danger ms-auto"
                            @onclick="() => RemoveItem(item.ProductId)"
                            disabled="@isProcessing">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            }
        }

        <!-- Error/Success Messages -->
        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert @(isSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
                @message
                <button type="button" class="btn-close" @onclick="ClearMessage"></button>
            </div>
        }
    </div>

    <!-- Footer -->
    @if (CartService.CartItems.Any() && !isProcessing)
    {
        <div class="cart-footer">
            <div class="d-flex justify-content-between mb-3">
                <strong>Total:</strong>
                <strong class="text-primary">₱@CartService.TotalPrice.ToString("N2")</strong>
            </div>
            <button class="btn btn-primary w-100 mb-2"
                    @onclick="HandleCheckout"
                    disabled="@isProcessing">
                <i class="bi bi-credit-card me-2"></i>Checkout
            </button>
            <button class="btn btn-outline-danger w-100"
                    @onclick="ClearCart"
                    disabled="@isProcessing">
                <i class="bi bi-trash me-2"></i>Clear Cart
            </button>
        </div>
    }
</div>

<style>
    .cart-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        animation: fadeIn 0.3s;
    }

    .cart-sidebar {
        position: fixed;
        top: 0;
        right: -450px;
        width: 450px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1050;
        transition: right 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
    }

        .cart-sidebar.open {
            right: 0;
        }

    .cart-header {
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .cart-body {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .cart-footer {
        padding: 1.5rem;
        border-top: 1px solid #dee2e6;
        background: #f8f9fa;
    }

    .cart-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 1rem;
        align-items: center;
    }

    .cart-item-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
    }

    .cart-item-details {
        flex: 1;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
    }

    .empty-cart {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@media (max-width: 576px) {
        .cart-sidebar {
            width: 100%;
            right: -100%;
        }
    }
</style>

@code {
    private bool isOpen = false;
    private bool isProcessing = false;
    private string message = string.Empty;
    private bool isSuccess = false;

    // TODO: Replace with actual user ID from authentication
    private string currentUserId = "user123"; // Temporary - replace with real auth

    protected override void OnInitialized()
    {
        CartService.OnCartToggled += HandleCartToggle;
        CartService.OnCartChanged += StateHasChanged;
    }

    private void HandleCartToggle(bool open)
    {
        isOpen = open;
        ClearMessage();
        StateHasChanged();
    }

    private void CloseCart()
    {
        CartService.CloseCart();
    }

    private void IncreaseQuantity(int productId)
    {
        var item = CartService.CartItems.FirstOrDefault(i => i.ProductId == productId);
        if (item != null)
        {
            CartService.UpdateQuantity(productId, item.Quantity + 1);
        }
    }

    private void DecreaseQuantity(int productId)
    {
        var item = CartService.CartItems.FirstOrDefault(i => i.ProductId == productId);
        if (item != null)
        {
            CartService.UpdateQuantity(productId, item.Quantity - 1);
        }
    }

    private void RemoveItem(int productId)
    {
        CartService.RemoveFromCart(productId);
        ClearMessage();
    }

    private void ClearCart()
    {
        CartService.ClearCart();
        ClearMessage();
    }

    private void HandleCheckout()
    {
        // Just navigate to the checkout page — don’t process yet
        CloseCart(); // optional: close the sidebar
        Navigation.NavigateTo("/userportal/checkout");
    }

    private void ClearMessage()
    {
        message = string.Empty;
        isSuccess = false;
    }

    public void Dispose()
    {
        CartService.OnCartToggled -= HandleCartToggle;
        CartService.OnCartChanged -= StateHasChanged;
    }
}