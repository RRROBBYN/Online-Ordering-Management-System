@page "/userportal"
@using FuzzySharp
@layout Layout.PortalLayout.UserLayout
@rendermode InteractiveServer
@using _4IdiotsInc.Model
@inject Components.Service.SearchService SearchService
@inject _4IdiotsInc.Repositories.ProductsRepository ProductsRepo
@inject _4IdiotsInc.Repositories.ProductCategoryRepository CategoryRepo
@inject Components.Service.CartService CartService

@implements IDisposable
<div class="container py-4">
    <!-- Header -->
    <h4 class="fw-semibold mb-4">Shop by Category</h4>

    <!-- Category Filter Tabs -->
    <div class="d-flex gap-2 mb-4 flex-wrap">
        <button class="btn @(selectedCategoryId == 0 ? "btn-light" : "btn-outline-light text-dark") rounded-pill px-4"
                @onclick="() => FilterByCategory(0)">
            All
        </button>
        @foreach (var category in categories)
        {
            <button class="btn @(selectedCategoryId == category.Id ? "btn-light" : "btn-outline-light text-dark") rounded-pill px-4"
                    @onclick="() => FilterByCategory(category.Id)">
                @category.Name
            </button>
        }
    </div>

    <!-- Product Grid -->
    @if (filteredProducts == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!filteredProducts.Any())
    {
        <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <p class="mt-3">No products found</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var product in filteredProducts)
            {
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="card h-100 border-0 shadow-sm product-card">
                        <!-- Product Image -->
                        <div class="position-relative overflow-hidden" style="height: 250px;">
                            <img src="@product.ImageUrl"
                                 alt="@product.Name"
                                 class="card-img-top w-100 h-100"
                                 style="object-fit: cover;">
                        </div>

                        <!-- Product Info -->
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title mb-2" style="min-height: 48px;">@product.Name</h6>
                            <p class="text-primary fw-bold mb-3">₱@product.Price.ToString("N2")</p>

                            <!-- Add to Cart Button -->
                            <button class="btn btn-primary w-100 mt-auto"
                                    @onclick="() => AddToCart(product.Id)">
                                <i class="bi bi-cart-plus me-2"></i>Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .product-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }

    .card-img-top {
        transition: transform 0.3s;
    }

    .product-card:hover .card-img-top {
        transform: scale(1.05);
    }
</style>

@code {
    private List<Products>? products;
    private List<Products>? filteredProducts;
    private List<ProductCategory> categories = new();
    private int selectedCategoryId = 0;
    private string currentSearchQuery = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to search service
        SearchService.OnSearchChanged += HandleSearch;

        try
        {
            products = await ProductsRepo.GetAllProductsAsync();
            categories = await CategoryRepo.GetAllCategoriesAsync();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading products: {ex.Message}");
            products = new List<Products>();
            filteredProducts = new List<Products>();
        }
    }


    public void Dispose()
    {
        SearchService.OnSearchChanged -= HandleSearch;
    }

    private void HandleSearch(string query)
    {
        Console.WriteLine($"UserPortal: Received search query '{query}'");
        currentSearchQuery = query;
        ApplyFilters();
        StateHasChanged();
    }

    // Rest of your code remains the same
    private void FilterByCategory(int categoryId)
    {
        selectedCategoryId = categoryId;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        if (products == null)
        {
            filteredProducts = new List<Products>();
            return;
        }

        IEnumerable<Products> currentFilter = products;

        // --- 1. Apply Category Filter ---
        if (selectedCategoryId != 0)
        {
            currentFilter = currentFilter.Where(p => p.CategoryId == selectedCategoryId);
        }

        // --- 2. Apply Enhanced Fuzzy Search Filter ---
        if (!string.IsNullOrWhiteSpace(currentSearchQuery))
        {
            var query = currentSearchQuery.ToLower().Trim();

            // Dynamic threshold based on query length
            int similarityThreshold;
            if (query.Length <= 2)
            {
                similarityThreshold = 85; // Very strict for 1-2 chars
            }
            else if (query.Length <= 4)
            {
                similarityThreshold = 60; // More lenient for 3-4 chars
            }
            else
            {
                similarityThreshold = 50; // Even more lenient for 5+ chars
            }

            currentFilter = currentFilter
                .Select(p =>
                {
                    var productName = p.Name.ToLower();

                    // Calculate multiple scores for better matching
                    var partialRatio = Fuzz.PartialRatio(productName, query);
                    var tokenSetRatio = Fuzz.TokenSetRatio(productName, query);
                    var tokenSortRatio = Fuzz.TokenSortRatio(productName, query);

                    // Bonus for direct substring match (e.g., "SCP" in "SCP-173")
                    var containsBonus = productName.Contains(query) ? 20 : 0;

                    // Bonus for starts-with match
                    var startsWithBonus = productName.StartsWith(query) ? 30 : 0;

                    // Use the best score among all methods, plus bonuses
                    var bestScore = Math.Max(Math.Max(partialRatio, tokenSetRatio), tokenSortRatio)
                                  + containsBonus
                                  + startsWithBonus;

                    return new
                    {
                        Product = p,
                        Score = Math.Min(bestScore, 100) // Cap at 100
                    };
                })
                .Where(x => x.Score >= similarityThreshold)
                .OrderByDescending(x => x.Score)
                .Select(x => x.Product);

            Console.WriteLine($"Search: '{query}' (threshold: {similarityThreshold})");
        }

        filteredProducts = currentFilter.ToList();
        Console.WriteLine($"Filtered products count: {filteredProducts.Count}");
    }

    private void AddToCart(int productId)
    {
        var product = products?.FirstOrDefault(p => p.Id == productId);
        if (product != null)
        {
            CartService.AddToCart(
                product.Id,
                product.Name,
                product.Price,
                product.ImageUrl
            );

            // Optionally open the cart sidebar

            Console.WriteLine($"Added {product.Name} to cart");
        }
    }
}
